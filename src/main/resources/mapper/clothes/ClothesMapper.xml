<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.miracle.coordifit.clothes.repository.ClothesRepository">

  <!-- ===== Clothes 기본 매핑 ===== -->
  <resultMap id="ClothesMap" type="com.miracle.coordifit.clothes.model.Clothes">
    <id     property="clothesId"    column="CLOTHES_ID"/>
    <result property="userId"       column="USER_ID"/>
    <result property="name"         column="NAME"/>
    <result property="brand"        column="BRAND"/>
    <result property="categoryCode" column="CATEGORY_CODE"/>
    <result property="clothesSize"  column="CLOTHES_SIZE"/>
    <result property="price"        column="PRICE"/>
    <result property="purchaseDate" column="PURCHASE_DATE"/>
    <result property="purchaseUrl"  column="PURCHASE_URL"/>
    <result property="description"  column="DESCRIPTION"/>
    <result property="wearCount"    column="WEAR_COUNT"/>
    <result property="lastWornDate" column="LAST_WORN_DATE"/>
    <result property="isActive"     column="IS_ACTIVE"/>
    <result property="createdBy"    column="CREATED_BY"/>
    <result property="createdAt"    column="CREATED_AT"/>
    <result property="updatedBy"    column="UPDATED_BY"/>
    <result property="updatedAt"    column="UPDATED_AT"/>
  </resultMap>

  <!-- ===== FileInfo 매핑 ===== -->
  <resultMap id="FileInfoMap" type="com.miracle.coordifit.common.model.FileInfo">
    <id     property="fileId"      column="FILE_ID"/>
    <result property="originalName" column="ORIGINAL_NAME"/>
    <result property="s3Key"        column="S3_KEY"/>
    <result property="s3Url"        column="S3_URL"/>
    <result property="bucketName"   column="BUCKET_NAME"/>
    <result property="fileSize"     column="FILE_SIZE"/>
    <result property="fileType"     column="FILE_TYPE"/>
    <result property="uploadBy"     column="UPLOAD_BY"/>
    <result property="uploadDate"   column="UPLOAD_DATE"/>
  </resultMap>

<!-- ===== INSERT (ID 선발급) ===== -->
<insert id="insertClothes" parameterType="com.miracle.coordifit.clothes.model.Clothes">
  <!-- ① INSERT 전에 CLOTHES_ID 생성해서 VO에 주입 -->
  <selectKey keyProperty="clothesId" resultType="string" order="BEFORE">
    SELECT 'C' || TO_CHAR(SYSDATE, 'YYMMDD') || LPAD(SEQ_CLOTHES.NEXTVAL, 3, '0')
    FROM DUAL
  </selectKey>

  INSERT INTO CLOTHES
    (CLOTHES_ID, USER_ID, NAME, BRAND, CATEGORY_CODE, CLOTHES_SIZE, PRICE,
     PURCHASE_DATE, PURCHASE_URL, DESCRIPTION, WEAR_COUNT, LAST_WORN_DATE,
     IS_ACTIVE, CREATED_BY, UPDATED_BY)
  VALUES
    (#{clothesId,jdbcType=VARCHAR}, #{userId}, #{name}, #{brand}, #{categoryCode}, #{clothesSize},
     #{price,jdbcType=NUMERIC},
     #{purchaseDate}, #{purchaseUrl}, #{description},
     NVL(#{wearCount,jdbcType=NUMERIC}, 0),
     #{lastWornDate},
     NVL(#{isActive}, 'Y'),
     #{createdBy}, #{updatedBy})
</insert>


  <!-- ===== UPDATE ===== -->
  <update id="updateClothes" parameterType="com.miracle.coordifit.clothes.model.Clothes">
    UPDATE CLOTHES
       SET NAME           = #{name},
           BRAND          = #{brand},
           CATEGORY_CODE  = #{categoryCode},
           CLOTHES_SIZE   = #{clothesSize},
           PRICE          = #{price,jdbcType=NUMERIC},
           PURCHASE_DATE  = #{purchaseDate,jdbcType=DATE},
           PURCHASE_URL   = #{purchaseUrl},
           DESCRIPTION    = #{description},
           WEAR_COUNT     = #{wearCount,jdbcType=NUMERIC},
           LAST_WORN_DATE = #{lastWornDate,jdbcType=DATE},
           UPDATED_BY     = #{updatedBy}
     WHERE CLOTHES_ID     = #{clothesId}
  </update>

  <!-- ===== DELETE ===== -->
  <delete id="deleteClothes">
    DELETE FROM CLOTHES WHERE CLOTHES_ID = #{clothesId}
  </delete>

  <delete id="deleteAllImageLinks">
    DELETE FROM CLOTHES_IMAGES WHERE CLOTHES_ID = #{clothesId}
  </delete>

  <delete id="deleteImageLink">
    DELETE FROM CLOTHES_IMAGES
     WHERE CLOTHES_ID = #{clothesId}
       AND FILE_ID    = #{fileId}
  </delete>

  <!-- ===== SELECT ===== -->
  <select id="findById" resultMap="ClothesMap">
    SELECT * FROM CLOTHES WHERE CLOTHES_ID = #{clothesId}
  </select>

  <select id="findAllByUser" resultMap="ClothesMap">
    SELECT *
      FROM CLOTHES
     WHERE USER_ID = #{userId}
       AND NVL(IS_ACTIVE,'Y')='Y'
     ORDER BY CREATED_AT DESC
  </select>

  <!-- ===== 이미지 링크 처리 ===== -->
  <insert id="insertImageLink" parameterType="com.miracle.coordifit.clothes.model.ClothesImageLink">
    INSERT INTO CLOTHES_IMAGES (CLOTHES_ID, FILE_ID, CREATED_BY)
    VALUES (#{clothesId}, #{fileId,jdbcType=NUMERIC}, #{createdBy})
  </insert>

  <select id="findImageLinks" resultType="com.miracle.coordifit.clothes.model.ClothesImageLink">
    SELECT CLOTHES_ID AS clothesId,
           FILE_ID    AS fileId,
           CREATED_BY AS createdBy
      FROM CLOTHES_IMAGES
     WHERE CLOTHES_ID = #{clothesId}
     ORDER BY FILE_ID ASC
  </select>

  <select id="countImageLinks" resultType="int">
    SELECT COUNT(*) FROM CLOTHES_IMAGES WHERE CLOTHES_ID = #{clothesId}
  </select>

  <!-- 실제 파일 정보 조회 -->
  <select id="findImageFiles" resultMap="FileInfoMap">
    SELECT f.*
      FROM FILE_INFO f
      JOIN CLOTHES_IMAGES ci ON f.FILE_ID = ci.FILE_ID
     WHERE ci.CLOTHES_ID = #{clothesId}
     ORDER BY f.FILE_ID ASC
  </select>

</mapper>
