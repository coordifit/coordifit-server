<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.miracle.coordifit.clothes.repository.ClothesMapper">

  <!-- ===== Clothes INSERT (선발급) ===== -->
  <insert id="insertClothes" parameterType="com.miracle.coordifit.clothes.model.Clothes">
    <selectKey keyProperty="clothesId" resultType="string" order="BEFORE">
      SELECT 'C' || TO_CHAR(SYSDATE, 'YYMMDD') || LPAD(TO_CHAR(SEQ_CLOTHES_ID.NEXTVAL), 3, '0')
      FROM DUAL
    </selectKey>
    INSERT INTO CLOTHES (
      CLOTHES_ID, USER_ID, NAME, BRAND, CATEGORY_CODE, CLOTHES_SIZE,
      PRICE, PURCHASE_DATE, PURCHASE_URL, DESCRIPTION,
      IS_ACTIVE, CREATED_BY
    ) VALUES (
      #{clothesId}, #{userId}, #{name}, #{brand}, #{categoryCode}, #{clothesSize},
      #{price}, #{purchaseDate, jdbcType=DATE}, #{purchaseUrl}, #{description},
      NVL(#{isActive}, 'Y'), #{createdBy}
    )
  </insert>

  <!-- ===== ResultMaps ===== -->
  <resultMap id="ClothesDetailMap" type="com.miracle.coordifit.clothes.dto.ClothesDetailResponseDto">
    <id     column="CLOTHES_ID"      property="clothesId"/>
    <result column="USER_ID"         property="userId"/>
    <result column="NAME"            property="name"/>
    <result column="BRAND"           property="brand"/>
    <result column="CATEGORY_CODE"   property="categoryCode"/>
    <result column="CATEGORY_NAME"   property="categoryName"/>
    <result column="CLOTHES_SIZE"    property="clothesSize"/>
    <result column="PRICE"           property="price" javaType="java.math.BigDecimal"/>
    <result column="PURCHASE_DATE"   property="purchaseDate" jdbcType="DATE"      javaType="java.time.LocalDate"/>
    <result column="PURCHASE_URL"    property="purchaseUrl"/>
    <result column="DESCRIPTION"     property="description"/>
    <result column="WEAR_COUNT"      property="wearCount" javaType="java.lang.Integer"/>
    <result column="LAST_WORN_DATE"  property="lastWornDate" jdbcType="DATE"      javaType="java.time.LocalDate"/>
    <result column="IS_ACTIVE"       property="isActive"/>
    <result column="CREATED_AT"      property="createdAt"  jdbcType="TIMESTAMP"  javaType="java.time.LocalDateTime"/>
    <result column="UPDATED_AT"      property="updatedAt"  jdbcType="TIMESTAMP"  javaType="java.time.LocalDateTime"/>

    <collection property="imageUrls" ofType="string"
                column="CLOTHES_ID"
                select="selectClothesImageUrls"/>
  </resultMap>

  <resultMap id="CodeMap" type="com.miracle.coordifit.clothes.dto.CodeDto">
    <id     column="CODE_ID"        property="codeId"/>
    <result column="CODE_NAME"      property="codeName"/>
    <result column="PARENT_CODE_ID" property="parentCodeId"/>
  </resultMap>

  <!-- ===== Clothes 조회 ===== -->
  <select id="selectClothesDetail" parameterType="string" resultMap="ClothesDetailMap">
    SELECT
      c.CLOTHES_ID, c.USER_ID, c.NAME, c.BRAND, c.CATEGORY_CODE,
      cc.CODE_NAME AS CATEGORY_NAME,
      c.CLOTHES_SIZE, c.PRICE, c.PURCHASE_DATE, c.PURCHASE_URL, c.DESCRIPTION,
      c.WEAR_COUNT, c.LAST_WORN_DATE, c.IS_ACTIVE,
      c.CREATED_AT, c.UPDATED_AT
    FROM CLOTHES c
    LEFT JOIN COMMON_CODES cc ON cc.CODE_ID = c.CATEGORY_CODE
    WHERE c.CLOTHES_ID = #{clothesId}
  </select>

  <select id="selectClothesList" parameterType="map" resultMap="ClothesDetailMap">
    SELECT
      c.CLOTHES_ID, c.USER_ID, c.NAME, c.BRAND, c.CATEGORY_CODE,
      cc.CODE_NAME AS CATEGORY_NAME,
      c.CLOTHES_SIZE, c.PRICE, c.PURCHASE_DATE, c.PURCHASE_URL, c.DESCRIPTION,
      c.WEAR_COUNT, c.LAST_WORN_DATE, c.IS_ACTIVE,
      c.CREATED_AT, c.UPDATED_AT
    FROM CLOTHES c
    LEFT JOIN COMMON_CODES cc ON cc.CODE_ID = c.CATEGORY_CODE
    WHERE c.USER_ID = #{userId}
    <if test="categoryCode != null and categoryCode != ''">
      AND c.CATEGORY_CODE = #{categoryCode}
    </if>
    ORDER BY c.CREATED_AT DESC
  </select>

  <!-- 이미지 URL -->
  <select id="selectClothesImageUrls" parameterType="string" resultType="string">
    SELECT fi.S3_URL
    FROM CLOTHES_IMAGES ci
    JOIN FILE_INFO fi ON fi.FILE_ID = ci.FILE_ID
    WHERE ci.CLOTHES_ID = #{clothesId}
    ORDER BY ci.CREATED_AT ASC
  </select>

  <!-- CLOTHES_IMAGES 벌크 insert -->
  <insert id="insertClothesImages">
    INSERT ALL
    <foreach collection="fileIds" item="fid">
      INTO CLOTHES_IMAGES (CLOTHES_ID, FILE_ID, CREATED_BY)
      VALUES (#{clothesId}, #{fid}, (SELECT CREATED_BY FROM CLOTHES WHERE CLOTHES_ID = #{clothesId}))
    </foreach>
    SELECT 1 FROM DUAL
  </insert>

  <!-- ===== 카테고리(COMMON_CODES) ===== -->
  <select id="selectTopCategories" resultMap="CodeMap">
    SELECT CODE_ID, CODE_NAME, PARENT_CODE_ID
    FROM COMMON_CODES
    WHERE IS_ACTIVE = 'Y'
      AND PARENT_CODE_ID = 'B10001'
    ORDER BY CODE_ID
  </select>

  <select id="selectChildren" parameterType="string" resultMap="CodeMap">
    SELECT CODE_ID, CODE_NAME, PARENT_CODE_ID
    FROM COMMON_CODES
    WHERE IS_ACTIVE = 'Y'
      AND PARENT_CODE_ID = #{parentCodeId}
    ORDER BY CODE_ID
  </select>

  <!-- ✅ 여기 'selectOne'은 단 한 번만! -->
  <select id="selectOne" parameterType="string" resultMap="CodeMap">
    SELECT CODE_ID, CODE_NAME, PARENT_CODE_ID
    FROM COMMON_CODES
    WHERE CODE_ID = #{codeId}
  </select>

  <!-- ===== FILE_INFO helpers ===== -->
  <select id="selectMaxFileId" resultType="long">
    SELECT MAX(FILE_ID) FROM FILE_INFO
  </select>

  <select id="selectFileIdsAfter" parameterType="long" resultType="long">
    SELECT FILE_ID
    FROM FILE_INFO
    WHERE FILE_ID > NVL(#{lastFileId, jdbcType=NUMERIC}, -1)
    ORDER BY FILE_ID
  </select>

</mapper>
