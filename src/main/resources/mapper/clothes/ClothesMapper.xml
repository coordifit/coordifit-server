<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.miracle.coordifit.clothes.repository.ClothesRepository">

  <resultMap id="ClothesMap" type="com.miracle.coordifit.clothes.model.Clothes">
    <id     property="clothesId"    column="CLOTHES_ID"/>
    <result property="userId"       column="USER_ID"/>
    <result property="name"         column="NAME"/>
    <result property="brand"        column="BRAND"/>
    <result property="categoryCode" column="CATEGORY_CODE"/>
    <result property="clothesSize"  column="CLOTHES_SIZE"/>
    <result property="price"        column="PRICE"/>
    <result property="purchaseDate" column="PURCHASE_DATE"/>
    <result property="purchaseUrl"  column="PURCHASE_URL"/>
    <result property="description"  column="DESCRIPTION"/>
    <result property="wearCount"    column="WEAR_COUNT"/>
    <result property="lastWornDate" column="LAST_WORN_DATE"/>
    <result property="isActive"     column="IS_ACTIVE"/>
    <result property="createdBy"    column="CREATED_BY"/>
    <result property="createdAt"    column="CREATED_AT"/>
    <result property="updatedBy"    column="UPDATED_BY"/>
    <result property="updatedAt"    column="UPDATED_AT"/>
  </resultMap>

  <resultMap id="FileInfoMap" type="com.miracle.coordifit.common.model.FileInfo">
    <id     property="fileId"       column="FILE_ID"/>
    <result property="originalName" column="ORIGINAL_NAME"/>
    <result property="s3Key"        column="S3_KEY"/>
    <result property="s3Url"        column="S3_URL"/>
    <result property="bucketName"   column="BUCKET_NAME"/>
    <result property="fileSize"     column="FILE_SIZE"/>
    <result property="fileType"     column="FILE_TYPE"/>
    <result property="uploadBy"     column="UPLOAD_BY"/>
    <result property="uploadDate"   column="UPLOAD_DATE"/>
  </resultMap>

  <insert id="insertClothes" parameterType="com.miracle.coordifit.clothes.model.Clothes">
    <selectKey keyProperty="clothesId" resultType="string" order="BEFORE">
      SELECT 'C'
             || TO_CHAR(SYSDATE, 'YYMMDD')
             || LPAD(
                  NVL((
                    SELECT MAX(TO_NUMBER(SUBSTR(c.CLOTHES_ID, 8)))
                      FROM CLOTHES c
                     WHERE SUBSTR(c.CLOTHES_ID, 2, 6) = TO_CHAR(SYSDATE, 'YYMMDD')
                  ), 0) + 1
                , 3, '0')
      FROM DUAL
    </selectKey>

    INSERT INTO CLOTHES (
      CLOTHES_ID, USER_ID, NAME, BRAND, CATEGORY_CODE, CLOTHES_SIZE, PRICE,
      PURCHASE_DATE, PURCHASE_URL, DESCRIPTION, WEAR_COUNT, LAST_WORN_DATE,
      IS_ACTIVE, CREATED_BY, CREATED_AT, UPDATED_BY, UPDATED_AT
    ) VALUES (
      #{clothesId}, #{userId}, #{name}, #{brand}, #{categoryCode}, #{clothesSize},
      #{price,jdbcType=NUMERIC},
      #{purchaseDate}, #{purchaseUrl}, #{description},
      NVL(#{wearCount,jdbcType=NUMERIC}, 0),
      #{lastWornDate},
      NVL(#{isActive}, 'Y'),
      #{createdBy}, CURRENT_TIMESTAMP,
      #{updatedBy}, CURRENT_TIMESTAMP
    )
  </insert>

  <update id="updateClothes" parameterType="com.miracle.coordifit.clothes.model.Clothes">
    UPDATE CLOTHES
       SET NAME           = #{name},
           BRAND          = #{brand},
           CATEGORY_CODE  = #{categoryCode},
           CLOTHES_SIZE   = #{clothesSize},
           PRICE          = #{price,jdbcType=NUMERIC},
           PURCHASE_DATE  = #{purchaseDate},
           PURCHASE_URL   = #{purchaseUrl},
           DESCRIPTION    = #{description},
           WEAR_COUNT     = NVL(#{wearCount,jdbcType=NUMERIC}, 0),
           LAST_WORN_DATE = #{lastWornDate},
           UPDATED_BY     = #{updatedBy},
           UPDATED_AT     = CURRENT_TIMESTAMP
     WHERE CLOTHES_ID     = #{clothesId}
  </update>

  <delete id="deleteClothes">
    DELETE FROM CLOTHES
     WHERE CLOTHES_ID = #{clothesId}
  </delete>

  <delete id="deleteAllImageLinks">
    DELETE FROM CLOTHES_IMAGES
     WHERE CLOTHES_ID = #{clothesId}
  </delete>

  <delete id="deleteImageLink">
    DELETE FROM CLOTHES_IMAGES
     WHERE CLOTHES_ID = #{clothesId}
       AND FILE_ID    = #{fileId}
  </delete>

  <select id="findById" resultMap="ClothesMap">
    SELECT *
      FROM CLOTHES
     WHERE CLOTHES_ID = #{clothesId}
  </select>

  <select id="findAllByUser" resultMap="ClothesMap">
    SELECT *
      FROM CLOTHES
     WHERE USER_ID = #{userId}
       AND NVL(IS_ACTIVE,'Y') = 'Y'
     ORDER BY CREATED_AT DESC
  </select>

  <insert id="insertImageLink" parameterType="com.miracle.coordifit.clothes.model.ClothesImageLink">
    INSERT INTO CLOTHES_IMAGES (
      CLOTHES_ID, FILE_ID, CREATED_AT, CREATED_BY
    ) VALUES (
      #{clothesId}, #{fileId,jdbcType=NUMERIC}, CURRENT_TIMESTAMP, #{createdBy}
    )
  </insert>

  <select id="findImageLinks" resultType="com.miracle.coordifit.clothes.model.ClothesImageLink">
    SELECT CLOTHES_ID AS clothesId,
           FILE_ID    AS fileId,
           CREATED_BY AS createdBy
      FROM CLOTHES_IMAGES
     WHERE CLOTHES_ID = #{clothesId}
     ORDER BY FILE_ID ASC
  </select>

  <select id="countImageLinks" resultType="int">
    SELECT COUNT(*)
      FROM CLOTHES_IMAGES
     WHERE CLOTHES_ID = #{clothesId}
  </select>

  <select id="findImageFiles" resultMap="FileInfoMap">
    SELECT f.*
      FROM FILE_INFO f
      JOIN CLOTHES_IMAGES ci ON f.FILE_ID = ci.FILE_ID
     WHERE ci.CLOTHES_ID = #{clothesId}
     ORDER BY f.FILE_ID ASC
  </select>

</mapper>
