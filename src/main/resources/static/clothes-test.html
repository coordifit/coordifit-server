<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<title>Clothes 등록 테스트</title>
<style>
  body{font-family:sans-serif;max-width:720px;margin:24px auto;padding:0 12px}
  label{display:block;margin:8px 0 4px}
  input,select,textarea{width:100%;padding:8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .thumbs img{max-height:80px;margin:4px;border:1px solid #ddd}
  .ok{color:#0a7}
  .err{color:#c00;white-space:pre-wrap}
</style>
<h1>Clothes 등록 (multipart / 이미지 필수)</h1>

<div class="row">
  <div>
    <label>상위 카테고리</label>
    <select id="parent"></select>
  </div>
  <div>
    <label>하위 카테고리</label>
    <select id="child"></select>
  </div>
</div>

<label>이름</label><input id="name" placeholder="예) 파란 셔츠">
<label>브랜드</label><input id="brand" placeholder="예) Uniqlo">
<div class="row">
  <div><label>사이즈</label><input id="size" placeholder="M"></div>
  <div><label>가격</label><input id="price" type="number" step="1" placeholder="49500"></div>
</div>
<div class="row">
  <div><label>구매일</label><input id="pdate" type="date"></div>
  <div><label>구매 URL</label><input id="purl" placeholder="https://..."></div>
</div>
<label>설명</label><textarea id="desc" rows="3"></textarea>

<label>이미지 (1~5장, jpg/png/webp)</label>
<input id="files" type="file" accept="image/*" multiple>
<div class="thumbs" id="thumbs"></div>

<button id="submit">등록</button>
<div id="msg"></div>
<pre id="out"></pre>

<script>
const API = "http://localhost:8080";
const $ = (id)=>document.getElementById(id);
const msg = (html,cls)=>{$("msg").className=cls; $("msg").innerHTML=html;}

async function loadParents() {
  const res = await fetch(`${API}/api/clothes/categories/parents`);
  const data = await res.json();
  $("parent").innerHTML = data.map(c=>`<option value="${c.codeId}">${c.codeName}</option>`).join("");
  await loadChildren($("parent").value);
}
async function loadChildren(pid) {
  const res = await fetch(`${API}/api/clothes/categories/children?parentCodeId=${encodeURIComponent(pid)}`);
  const data = await res.json();
  $("child").innerHTML = data.map(c=>`<option value="${c.codeId}">${c.codeName}</option>`).join("");
}

$("parent").addEventListener("change", e => loadChildren(e.target.value));

$("files").addEventListener("change", e=>{
  const files = Array.from(e.target.files||[]);
  const box = $("thumbs"); box.innerHTML="";
  files.slice(0,5).forEach(f=>{
    const img = document.createElement("img");
    img.src = URL.createObjectURL(f);
    box.appendChild(img);
  });
});

$("submit").addEventListener("click", async ()=>{
  try{
    const files = Array.from($("files").files||[]);
    if(files.length<1 || files.length>5){ msg("이미지는 1~5장 선택하세요.", "err"); return; }

    const data = {
      categoryCode: $("child").value,
      name: $("name").value,
      brand: $("brand").value,
      clothesSize: $("size").value,
      price: $("price").value? Number($("price").value): null,
      purchaseDate: $("pdate").value || null,
      purchaseUrl: $("purl").value || null,
      description: $("desc").value || null
    };

    const fd = new FormData();
    fd.append("data", JSON.stringify(data));
    files.forEach(f => fd.append("files", f));

    msg("등록 중...", "");
    const res = await fetch(`${API}/api/clothes`, { method:"POST", body: fd });
    const json = await res.json();
    if(!res.ok){ msg("에러\n"+(json.message||res.statusText), "err"); $("out").textContent = JSON.stringify(json,null,2); return; }

    msg("등록 성공 ✅", "ok");
    $("out").textContent = JSON.stringify(json, null, 2);

    // 결과 이미지 미리보기
    if(json.imageUrls && json.imageUrls.length){
      const box = $("thumbs"); box.innerHTML="";
      json.imageUrls.forEach(u=>{
        const img = document.createElement("img"); img.src = u; box.appendChild(img);
      });
    }
  }catch(e){
    msg("예외 발생:\n"+e, "err");
  }
});

loadParents();
</script>
